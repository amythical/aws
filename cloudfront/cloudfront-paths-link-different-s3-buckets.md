# Usecase
Users can access public images using a path like public/image1.png and protected images like protected/image2.png using the same CDN/Cloudfront distribution url. Protected images may need the user to log in to the app to view them using a CDN url.

# Approach
- Part 1 - Use Cloud front Paths
Cloudfront has a paths feature where different origins(and hence buckets) can be linked based on the path of the resource. We link public/image1.png to the public bucket and protected/image2.png to a protected resources bucket.

- Part 2 - Use signed cookies from Cloud front to give access to protected content

# Note on signed urls
Signed urls are also available from S3 which could leverage the Authorization header and provide permissions as per IAM Roles, but If we use S3 signed urls the entire purpose of CDN caching does not come into play and every single request hits the S3 bucket. This is as good as not using the CDN.
Cloud flare introduced signed urls and signed cookies to block/permit access to private/protected content. We will use signed cookies to ensure we use the CDN while accessing the image from the S3 bucket.

# Implementation Part 1 - Using cloud front Paths
## Create another S3 Bucket
- Create a bucket in S3, called 'ptotected-assets' block all public access
- Create a folder called 'protected'
- Upload an image to the bucket say wallpaper.png to the folder called 'protected'
- From the buckets Objects Tab -> wallpaper.png, copy the Object url
- If you paste it in your browser you should get a 
```
<Error>
<Code>AccessDenied</Code>
<Message>Access Denied</Message>
<RequestId>SomeRand0mNumbers&Characters</RequestId>
<HostId>SomeMoreRand0mNumbers&Characters</HostId>
</Error>
```
- So we now have a S3 Bucket with private access such that no one can access it using the S3 Object urls

## Cloud Front Add New Origin
- Cloud front -> Distributions -> Your distribution
- Continuing from [Linking S3 Bucket to CDN for public access](https://github.com/amythical/aws/blob/main/cloudfront/cloudfront-public-access-private-s3-bucket.md), we assume there is an origin called 'public-assets' linking the 'public-assets' S3 bucket to the CDN
- Go to the Origins Tab and click Create origin
   - Origin domain - Choose the bucket 'protected-assets' we just created above
    - Origin path can be empty
    - Name would be autopopulated with origins name or edit and add your own eg 'protected-assets-origin'
    - Origin access select Origin access control settings (recommended) Bucket can restrict access to only CloudFront.
    - Origin access control -> Create control setting
        - Name eg cdn-s3-protected-access
        - Description can be optional
        - Signing behaviour, select Sign requests (recommended) and check Do not override authorization header
    - Copy the auto generated policy 'Copy Policy' button and store it somewhere handy
    - Create

## Give the new S3 Bucket permissions to Cloud Front Distribution
    - S3 Buckets -> protected-assets -> Permissions Tab
    - Bucket policy -> Edit
    - Paste the autogenerated policy for we stashed above
    - Save change (to policy)

## Configure Cloud Front paths
- Cloud Front -> Distributions -> Your Distribution -> Behaviours tab
- We will see a default behavior with path pattern as Default(*), this is mapped to our 'public-assets' origin
- Create the path for the public assets
    - Click on Create Behaviour in the Edit Behaviour form
    - Path pattern - /public/*
    - Origin and origin groups - select the 'public-assets' origin
    - Rest of the options can be default
    - Save Changes
- Create the path for the protected assets
    - Click on Create Behaviour in the Edit Behaviour form
    - Path pattern - /protected/*
    - Origin and origin groups - select the 'protected-assets' origin
    - Rest of the options can be default
    - Save Changes

## Add a folder to the 'public-assets' bucket
    - S3 Buckets, public-assets, create a folder called 'public'
    - Upload an image say image1.png to it
    - From the buckets Objects Tab -> image1.png, copy the Object url
    - If you paste it in your browser you should get a 
    ```
    <Error>
    <Code>AccessDenied</Code>
    <Message>Access Denied</Message>
    <RequestId>SomeRand0mNumbers&Characters</RequestId>
    <HostId>SomeMoreRand0mNumbers&Characters</HostId>
    </Error>
    ```
    - So we now the public folder also has access such that no one can access it using the S3 Object urls


## Check access to images using paths
### Check the /public assets
- Cloudfront->Distributions->Your distribution->General, copy the distribution name (url like https://somecharactersandnumbers.cloudfront.net)
- In your browser try https://somecharactersandnumbers.cloudfront.net/public/image1.png
- Yay! we now see the image using cloudfront!
- Because the path contained /public our requested was routed and fetched from the public-assets bucket as per our configuration in Cloud Front Behaviours (paths)

### Check the /protected assets
- Cloudfront->Distributions->Your distribution->General, copy the distribution name (url like https://somecharactersandnumbers.cloudfront.net)
- In your browser try https://somecharactersandnumbers.cloudfront.net/protected/wallpaper.png
- You should see the image
- So the /protected path takes us to the protected-assets bucket
- This image is not really protected as of now, as anyone can access it.

# Implementation - Part 2 - give access to logged in users only for the protected-assets


