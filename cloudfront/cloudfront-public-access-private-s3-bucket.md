# Use Case
Users can only access images from a S3 bucket using a cloudfront url. Any attempt to directly access the S3 object using a S3 url should not be allowed.

# Approach
- S3 bucket with private permissions + permissions for cloudfront distribution to access its objects
- Cloudfront distribution with origin as private S3 bucket

# Implementation Details
## The S3 Bucket
- Create a bucket in S3, block all public access
- Upload an image to the bucket say image.png
- From the buckets Objects Tab -> image.png, copy the Object url
- If you paste it in your browser you should get a 
```
<Error>
<Code>AccessDenied</Code>
<Message>Access Denied</Message>
<RequestId>SomeRand0mNumbers&Characters</RequestId>
<HostId>SomeMoreRand0mNumbers&Characters</HostId>
</Error>
```
- So we now have a private S3 Bucket

## The Cloudfront Distribution
- Create a Cloudfront Distribution
    - Origin domain - Choose the bucket we just created above xyz-yourregion.amazonaws.com
    - Origin path can be empty
    - Name would be autopopulated with origins name or edit and add your own
    - Origin access select Origin access control settings (recommended) Bucket can restrict access to only CloudFront.
    - Origin access control -> Create control setting
        - Name eg cdn-s3-public-access
        - Description can be optional
        - Signing behaviour, select Sign requests (recommended) and check Do not override authorization header
        - Create
    - We can also see "You must allow access to CloudFront using this policy statement." and a "Copy Policy" button. We can copy a readymade bucket policy autogenerated for us by AWS and keep it handy somewhere to use soon.
    - Add custom header - optional
    - Enable Origin Shield , No
    - Rest of the options can be default
    - Add a description, it helps in the dashboard to find your distribution when you have many listed
    - Click on Create Distribution

## Check Access using Cloudfront
    - Cloudfront->Distributions->Your distribution->General, copy the distribution name
    - In your browser try https://your-distribution-linkname.cloudfront.net/image.png
    - We still get 
    ```
    <Error>
    <Code>AccessDenied</Code>
    <Message>Access Denied</Message>
    <RequestId>SomeRand0mNumbers&Characters</RequestId>
    <HostId>SomeMoreRand0mNumbers&Characters</HostId>
    </Error>
    ```
    Remember S3 is private, so we need to give our distribution permission to access S3


## S3 permissions modify to give access to cloudfront distribution
    - Before this step, go to Cloudfront->Distributions->Your distribution->General, Copy the ARN 
    - S3 -> Buckets -> your bucket -> Permissions -> Bucket policy -> Edit
    - We can see use the autogenerated Policy we copied above in 'The CloudFrint distribution' or here is the complete Policy JSON that can be copied, make sure to replace 'your-bucket-name' and 'your-cloudfront-distribution-arn-copied-above'

    ```
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Sid": "AllowCloudFrontServicePrincipalReadOnly",
			"Effect": "Allow",
			"Principal": {
				"Service": "cloudfront.amazonaws.com"
			},
			"Action": "s3:GetObject",
			"Resource": "arn:aws:s3:::your-bucket-name/*",
			"Condition": {
				"StringEquals": {
					"AWS:SourceArn": your-cloudfront-distribution-arn-copied-above
				}
			}
		}
	]
}
    ```
    - Save changes (to policy)

## Check the image URL using cloudfront
    -  Cloudfront->Distributions->Your distribution->General, copy the distribution name
    - In your browser try https://your-distribution-linkname.cloudfront.net/image.png
    - Yay! we now see the image using cloudfront!!!

## Oops getting Access Denied error using Cloudfront URL?
    - Did you still get 
    ```
    <Error>
    <Code>AccessDenied</Code>
    <Message>Access Denied</Message>
    <RequestId>SomeRand0mNumbers&Characters</RequestId>
    <HostId>SomeMoreRand0mNumbers&Characters</HostId>
    </Error>
    ```
    - So there is a configuration issues ... we get an access denied that means S3 is not letting Cloudfront access the image, the connecting links are the S3 Policy and Cloudfronts Origin Access
    - Check if the S3 Policy has given access to our cloudfront distribution by confirming the bucketname and the Cloudfront ARN name 
    - Lets also confirm the Origin Access we configured
    - AWS -> Cloudfront -> Distribution, select checkbox from dashboard and Disable
    - AWS -> Cloudfront -> Origin Access -> select the origin access we created in 'Cloud front Distribution' and we called it 'cdn-s3-public-access'
        - Select the checkbox and click on the Edit button
        - Settings -> Have we selected the Do Not Sign Headers option? We need to select Signing Behaviour instead of Do not sign requests, select Sign requests (recommended) and check Do not override authorization header
        - Save Changes
    - AWS -> Cloudfront - Distributions - click on the distribution to edit -> Origins tab, select the origin and Edit
        - Select the origin access control again to 'cdn-s3-public-access'
        - Save Changes
    - AWS -> Cloudfront -> Distribution, select checkbox from dashboard and Enable
    
## Check the image URL using cloudfront
    -  Cloudfront->Distributions->Your distribution->General, copy the distribution name
    - In your browser try https://your-distribution-linkname.cloudfront.net/image.png
    - Yay! we now see the image using cloudfront!!!

